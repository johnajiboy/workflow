name: Deploy Laravel to EC2

on:
  push:
    branches:
      - main  # or your deployment branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y zip unzip git
        curl -sS https://getcomposer.org/installer | php
        sudo mv composer.phar /usr/local/bin/composer
        composer install --no-dev --optimize-autoloader

    - name: Run Tests
      run: |
        php artisan test

    - name: Deploy to EC2
      env:
        EC2_HOST: ec2-13-53-41-201.eu-north-1.compute.amazonaws.com # Replace with your EC2 instance public DNS or IP
        EC2_USER: ubuntu  # or the user you're using to SSH into the instance
        EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      run: |
        echo "${EC2_SSH_KEY}" > ec2_key.pem
        chmod 400 ec2_key.pem
        
        scp -i ec2_key.pem -r ./* $EC2_USER@$EC2_HOST:/var/www/html/your_laravel_project
        
        ssh -i ec2_key.pem $EC2_USER@$EC2_HOST << 'EOF'
          cd /var/www/html/your_laravel_project
          composer install --no-dev --optimize-autoloader
          php artisan migrate --force
          php artisan config:cache
          php artisan route:cache
          php artisan view:cache
          sudo service nginx restart  # or apache2 depending on your web server
        EOF

    - name: Clean up
      run: |
        rm ec2_key.pem
